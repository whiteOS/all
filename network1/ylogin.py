# 导入包
import time,socket,requests,random,datetime,pywifi
from pywifi import const



def connect_wifi(ssidd):
    print("连接WiFi中......")
    wifi = pywifi.PyWiFi()  # 创建一个wifi对象
    ifaces = wifi.interfaces()[0]  # 取第一个无线网卡
    ifaces.disconnect()  # 断开网卡连接
    time.sleep(4)  # 缓冲0.5秒
    profile = pywifi.Profile()  # 配置文件
    profile.ssid = ssidd  # wifi名称
    ifaces.remove_all_network_profiles()  # 删除其他配置文件
    tmp_profile = ifaces.add_network_profile(profile)  # 加载配置文件
    ifaces.connect(tmp_profile)  # 连接
    time.sleep(3)  # 2秒能否成功连接
    isok = True
    if ifaces.status() == const.IFACE_CONNECTED:
        return True
    else:
        return False

# 判断网络状态
def is_net_ok():
    s=socket.socket()
    s.settimeout(0.3)
    try:
        print("测试网络是否接通...")
        status = s.connect_ex(('220.181.38.148',443))
        if status == 0:
            print("网络已连接...")
            s.close()
            return True
        else:
            print("网络未连接，请检查...")
            s.close()
            return False
    except:
        print("网络未连接，请检查...")
        connect_wifi("csust-yd")
        s.close()
        pass    # 没网就继续下一步，什么都不用管


#获取IPv4地址
def getIP():
    hostname = socket.gethostname()
    ip =socket.gethostbyname(hostname)
    print(ip)
    return ip


# 登录
def login_request():
    LOGIN_PAGE_URL = "http://192.168.7.221:801/eportal/?c=ACSetting&a=Login&protocol=http:&hostname=192.168.7.221&iTermType=1&wlanuserip={0:}&wlanacip=192.168.130.254&wlanacname=ME60-X8-1&mac=c9-cc-a2-09-15-de&ip={0:}&enAdvert=0&queryACIP=0&loginMethod=1".format(getIP())
    n = random.randint(0, len(ACCS))
    Username = str(ACCS[n])
    data1 = {"DDDDD": ",0," + Username,"upass": "123456","OMKKey": "123456","R1": "0","R2": "0","R3": "0", "R6": "0","para": "00"}
    try:
        result = requests.post(LOGIN_PAGE_URL, data = data1)
        if is_net_ok():
            print("校园网登录成功！")
            return True
        else :
            return False
    except:
        return False



# 主程序
def main():
    if is_net_ok():    # 有网
        return True
    else:   #没网
        if login_request():   # 登录成功
            return True
        else:
            return False



def timesure():
    year = datetime.datetime.now().year
    month = datetime.datetime.now().month
    if month < 10:
        month = "0" + str(month)
    day = datetime.datetime.now().day
    if day < 10:
        day = "0" + str(day)
    nowtime = int(str(year) + str(month) + str(day))
    diedline = 120220501
    if nowtime < diedline:
        return True
    else:
        return False






ACCS = [
'202008060101',
'202008060110',
'202008060218',
'202008060221',
'202008060329',
'202008060405',
'202008060409',
'202008060420',
'202008060427',
'202008060622',
'202008060629',
'202008060710',
'202008060918',
'202008061002',
'202008061012',
'202008061014',
'202008061017',
'202002140204',
'202002140306',
'202002140309',
'202002140321',
'202002140510',
'202002140821',
'202002140922',
'202002140924',
'202002141005',
'202002141019',
'202002141032',
'202002141231',
'202002141419',
'202033010104',
'202033010107',
'202007240119',
'202001150417',
'202001150427',
'202001150508',
'202001150616',
'202010080115',
'202004080612',
'202004080902',
'202004080204',
'202004080215',
'202004080227',
'202004080327',
'202004080422',
'202004080432',
'202004080508',
'202004080627',
'202006110115',
'202006110126',
'202006110217',
'202006110433',
'202012020212',
'202012020226',
'202012020314',
'202012020318',
'202012020323',
'202012020401',
'202012020404',
'202012020408',
'202012020413',
'202012020415',
'202012020417',
'202012020419',
'202033010129',
'202002140126',
'202002140206',
'202002140229',
'202002140232',
'202002140412',
'202002140523',
'202002140603',
'202002140605',
'202002140617',
'202002140707',
'202002140709',
'202002140711',
'202002140732',
'202002140808',
'202002140810',
'202002140910',
'202002140914',
'202002141133',
'202002141218',
'202002141233',
'202008060132',
'202008060226',
'202008060232',
'202008060305',
'202008060309',
'202008060323',
'202008060331',
'202008060333',
'202008060714',
'202008060718',
'202008060828',
'202008060901',
'202008060904',
'202008061023',
'202008061024',
'202008061025',
'202006120131',
'202005020108',
'202005020207',
'202005020215',
'202010080204',
'202003130113',
'202003130132',
'202003130220',
'202003130501',
'202003130511',
'202003130719',
'202003130810',
'202003130910',
'202003131011',
'202003131029',
'202003131033',
'202003131105',
'202003131107',
'202003131228',
'202003131307',
'202003131415',
'202001150202',
'202001150321',
'202001150528',
'202011250113',
'202011250115',
'202011250328',
'202011250434',
'202011250614',
'202001140134',
'202001140203',
'202001140208',
'202001140422',
'202001140431',
'202001140519',
'202001140607',
'202001140619',
'202028020114',
'202028020230',
'202028020302',
'202028020319',
'202028020402',
'202028020410',
'202028020418',
'202028020513',
'202028020605',
'202028020619',
'202001050204',
'202001050319',
'202008030210',
'202008030303',
'202001030112',
'202001030221',
'202001030223',
'202006080217',
'202002050214',
'202002050225',
'202006100205',
'202006100329',
'202006100514',
'202010040103',
'202010040129',
'202006110431',
'202010010225',
'202004220333',
'202012060121',
'202012060126',
'202012060228',
'202005040216',
'202009450303',
'202007220109',
'202007220412',
'202007220419',
'202011070116',
'202011070204',
'202011070211',
'202007080116',
'202007080201',
'202007080203',
'202007080231',
'202007080317',
'202013010209',
'202013010217',
'202004330121',
'202004330128',
'202007210110',
'202007210203',
'202007050216',
'202027020103',
'202027020302',
'202027020316',
'202009010214',
'202013060118',
'202013060206',
'202013060214',
'202011180104',
'202011180129',
'202011180134',
'202008170105',
'202008170108',
'202005060116'
]
while True:
    if timesure():
        try:
            if main():
                time.sleep(1)
        except:
            pass
    else:
        print("已过期")
        break